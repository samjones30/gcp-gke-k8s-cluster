version: 2.1

jobs:
  format_terraform:
    docker:
      - image: docker.mirror.hashicorp.services/hashicorp/terraform:light
    steps:
      - checkout
      - run:
          name: Check Terraform formatting
          command: |
            terraform fmt -chdir=./terraform
  validate_terraform:
    docker:
      - image: docker.mirror.hashicorp.services/hashicorp/terraform:light
    steps:
      - checkout
      - run:
          name: Validate Terraform
          command: |
            terraform init -chdir=./terraform
            terraform validate -chdir=./terraform
  plan_terraform:
    docker:
      - image: docker.mirror.hashicorp.services/hashicorp/terraform:light
    steps:
      - checkout
      - run:
          name: Plan Terraform
          command: |
            terraform init -chdir=./terraform
            terraform plan -chdir=./terraform
  apply_terraform:
    docker:
      - image: docker.mirror.hashicorp.services/hashicorp/terraform:light
    steps:
      - checkout
      - run:
          name: Apply Terraform
          command: |
            terraform init -chdir=./terraform
            terraform apply -chdir=./terraform --auto-approve=true

workflows:
  terraform_workflow:
    jobs:
      - format_terraform
      - validate_terraform
      - plan_terraform:
          requires:
            - validate_terraform
      - hold_apply:
          type: approval
          requires:
            - plan_terraform
      - apply_terraform:
          filters:
            branches:
              only: master
          requires:
            - hold_apply
